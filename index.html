<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>LIQUIIUM ARENA — Index v2.0</title>
  <meta name="description" content="LIQUIIUM ARENA Index v2.0 — Picasso × Miró Synesthetic Fusion">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    @keyframes float-miro {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-10px) rotate(5deg); }
    }
    @keyframes cubist-shift {
      0%, 100% { transform: skew(0deg, 0deg); }
      50% { transform: skew(2deg, -2deg); }
    }
    body {
      font-family: 'Courier New', monospace;
      background: linear-gradient(45deg, #f4e04d 0%, #4ecdc4 25%, #ff6b6b 50%, #f4e04d 75%, #4ecdc4 100%);
      background-size: 400% 400%;
      animation: gradient-flow 15s ease infinite;
      color: #1a1a1a;
      overflow-x: hidden;
      position: relative;
    }
    @keyframes gradient-flow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    body::before {
      content: '★ ◐ ◯ ◑ ✦';
      position: fixed;
      top: 10%;
      right: 5%;
      font-size: 3rem;
      color: rgba(255, 107, 107, 0.3);
      animation: float-miro 6s ease-in-out infinite;
      pointer-events: none;
    }
    body::after {
      content: '◆';
      position: fixed;
      bottom: 15%;
      left: 8%;
      font-size: 5rem;
      color: rgba(78, 205, 196, 0.4);
      transform: rotate(45deg);
      animation: cubist-shift 4s ease-in-out infinite;
      pointer-events: none;
    }
    .synesthetic-grid {
      display: grid;
      grid-template-columns: 1fr 2fr 1fr;
      grid-template-rows: auto 1fr auto;
      gap: 20px;
      padding: 20px;
      min-height: 100vh;
      transform: skew(-0.5deg);
    }
    .synesthetic-panel {
      background: rgba(255, 255, 255, 0.85);
      border: 4px solid #1a1a1a;
      border-radius: 0;
      padding: 20px;
      box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.3), -4px -4px 0 rgba(255, 255, 255, 0.5);
      position: relative;
      overflow: hidden;
      transform: skew(0.5deg);
    }
    .synesthetic-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: repeating-linear-gradient(90deg, #ff6b6b 0px, #ff6b6b 10px, #4ecdc4 10px, #4ecdc4 20px, #f4e04d 20px, #f4e04d 30px);
    }
    .synesthetic-panel::after {
      content: '◯';
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.5rem;
      color: rgba(255, 107, 107, 0.4);
      animation: float-miro 5s ease-in-out infinite;
    }
    #GGC_HEADER {
      grid-column: 1 / -1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
      color: white;
      border: 5px solid #1a1a1a;
      box-shadow: 12px 12px 0 rgba(0, 0, 0, 0.4);
    }
    #GGC_HEADER::before {
      background: repeating-linear-gradient(90deg, #1a1a1a 0px, #1a1a1a 15px, #f4e04d 15px, #f4e04d 30px);
    }
    #VIS_RELATIONAL {
      grid-row: 2;
      grid-column: 1;
      background: rgba(78, 205, 196, 0.2);
      border-color: #4ecdc4;
      transform: rotate(-1deg) skew(0.5deg);
    }
    #EUYSTACIO_CHAT {
      grid-row: 2;
      grid-column: 2;
      position: relative;
      overflow: hidden;
      background: rgba(244, 224, 77, 0.15);
      border-color: #f4e04d;
    }
    #VIS_EQUILIBRIUM {
      grid-row: 2;
      grid-column: 3;
      background: rgba(255, 107, 107, 0.2);
      border-color: #ff6b6b;
      transform: rotate(1deg) skew(0.5deg);
    }
    #VIS_SFI {
      grid-column: 1 / 3;
      grid-row: 3;
      background: linear-gradient(to right, rgba(78, 205, 196, 0.15), rgba(244, 224, 77, 0.15));
      border: 4px dashed #1a1a1a;
    }
    #GGC_DOCS_PORTAL {
      grid-column: 3;
      grid-row: 3;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 107, 107, 0.3);
      border-color: #ff6b6b;
      transform: rotate(-0.5deg);
    }
    .full-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      opacity: 0.1;
    }
    button {
      background: #ff6b6b;
      border: 3px solid #1a1a1a;
      color: white;
      padding: 10px 20px;
      border-radius: 0;
      cursor: pointer;
      font-weight: bold;
      font-family: 'Courier New', monospace;
      box-shadow: 4px 4px 0 #1a1a1a;
      transition: all 0.2s;
      transform: skew(-2deg);
    }
    button:hover {
      background: #4ecdc4;
      transform: skew(-2deg) translateY(-2px);
      box-shadow: 6px 6px 0 #1a1a1a;
    }
    button:active {
      transform: skew(-2deg) translateY(0);
      box-shadow: 2px 2px 0 #1a1a1a;
    }
    input, select {
      background: rgba(255, 255, 255, 0.9);
      border: 3px solid #1a1a1a;
      color: #1a1a1a;
      padding: 8px;
      border-radius: 0;
      font-family: 'Courier New', monospace;
      box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.2);
    }
    input:focus, select:focus {
      outline: none;
      border-color: #ff6b6b;
      box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.3);
    }
    .muted-small {
      font-size: 0.85rem;
      opacity: 0.8;
      color: #1a1a1a;
    }
    h2, h3 {
      color: #1a1a1a;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 2px;
      position: relative;
      display: inline-block;
    }
    h2::after, h3::after {
      content: '◆';
      margin-left: 8px;
      color: #ff6b6b;
      font-size: 0.7em;
    }
    #GGC_BRAND {
      font-size: 24px !important;
      font-weight: 900 !important;
      text-shadow: 3px 3px 0 rgba(0, 0, 0, 0.3);
      letter-spacing: 3px;
    }
    #graph_container {
      background: repeating-conic-gradient(from 0deg at 50% 50%, rgba(78, 205, 196, 0.1) 0deg, rgba(78, 205, 196, 0.1) 30deg, transparent 30deg, transparent 60deg);
      border: 3px solid #4ecdc4;
      position: relative;
    }
    #graph_container::before {
      content: '★';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 4rem;
      color: rgba(78, 205, 196, 0.3);
      animation: float-miro 8s ease-in-out infinite;
    }
    #chat_area {
      background: rgba(255, 255, 255, 0.5) !important;
      border: 3px dashed #1a1a1a !important;
      box-shadow: inset 3px 3px 0 rgba(0, 0, 0, 0.1);
    }
    #equilibrium_gauge {
      border: 4px solid #ff6b6b;
      background: repeating-linear-gradient(45deg, rgba(255, 107, 107, 0.05), rgba(255, 107, 107, 0.05) 10px, transparent 10px, transparent 20px);
    }
    #sfi_waveform {
      background: repeating-linear-gradient(90deg, rgba(78, 205, 196, 0.1) 0px, rgba(78, 205, 196, 0.1) 20px, rgba(244, 224, 77, 0.1) 20px, rgba(244, 224, 77, 0.1) 40px) !important;
      border: 3px solid #4ecdc4;
    }
    @media (max-width: 1024px) {
      .synesthetic-grid {
        grid-template-columns: 1fr;
        grid-template-rows: auto;
        transform: skew(0);
      }
      #GGC_HEADER, #VIS_RELATIONAL, #EUYSTACIO_CHAT, #VIS_EQUILIBRIUM, #VIS_SFI, #GGC_DOCS_PORTAL {
        grid-column: 1;
        grid-row: auto;
        transform: skew(0);
      }
    }
  </style>
</head>
<body>
  <div class="synesthetic-grid" id="app_root" data-ie="1.000">
    <div id="GGC_HEADER" class="synesthetic-panel" role="banner" aria-label="GGC Header">
      <div style="display:flex;gap:12px;align-items:center">
        <button id="GoogleLoginBtn" aria-label="Authenticate via Google">Sign in with Google</button>
        <div id="GGC_BRAND" style="font-size:18px;font-weight:700">LIQUIIUM ARENA</div>
        <div class="muted-small" id="logged_in_user" aria-live="polite" style="margin-left:8px"></div>
      </div>
      <div style="text-align:right">
        <div id="NCP_STATUS" data-ie-band="normal" style="font-weight:600">Equilibrium Flow: Stable Harmony.</div>
        <div class="muted-small" id="tfm_status">TFM-1: ready</div>
      </div>
    </div>

    <aside id="VIS_RELATIONAL" class="synesthetic-panel" aria-label="Knowledge Graph (Euystacio)">
      <h3 style="margin-top:0">Euystacio Knowledge Graph</h3>
      <div id="graph_container" style="height:360px;"></div>
      <div class="muted-small" style="margin-top:10px">Interactive, node-based visualisation — drag to explore. Node distance &amp; thickness show correlation strength.</div>
    </aside>

    <main id="EUYSTACIO_CHAT" class="synesthetic-panel" aria-label="Euystacio Chat">
      <canvas id="Euy_Kernel_Cascade" class="full-canvas" aria-hidden="true"></canvas>
      <div id="Euy_Chat_Window" style="position:relative;z-index:2;padding:12px;max-width:900px;margin:auto">
        <h2 style="margin:0 0 8px 0">Euystacio Kernel Chat</h2>
        <div id="chat_area" style="height:320px;overflow:auto;background:rgba(0,0,0,0.18);border-radius:8px;padding:10px">Connecting…</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="chat_input" placeholder="Ask Euystacio…" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff">
          <button id="chat_send" style="padding:10px 12px;border-radius:8px">Send</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <div class="muted-small">Kernel WS:</div>
          <div id="ws_status" class="muted-small">disconnected</div>
        </div>
      </div>
    </main>

    <section id="VIS_EQUILIBRIUM" class="synesthetic-panel equilibrium-gauge" role="region" aria-label="Systemic Equilibrium Gauge">
      <div style="width:100%;text-align:center">
        <h3 style="margin-top:0">Systemic Equilibrium Status</h3>
        <canvas id="equilibrium_gauge" width="360" height="360" aria-label="Equilibrium 3D gauge"></canvas>
        <div style="text-align:center;margin-top:8px">
          <span id="ie_value" style="font-weight:700">IE = 1.000</span>
          <div class="muted-small" id="em_info">E vs M — awaiting telemetry</div>
        </div>
      </div>
    </section>

    <section id="VIS_SFI" class="synesthetic-panel">
      <h3 style="margin-top:0">Social Frequency Index (SFI)</h3>
      <div id="sfi_waveform" style="height:120px;background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent);border-radius:8px"></div>
      <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
        <label class="muted-small">Axis:</label>
        <select id="sfi_axis" class="muted-small">
          <option value="sentiment">Sentiment</option>
          <option value="anxiety">Anxiety</option>
          <option value="engagement">Engagement</option>
        </select>
        <div style="flex:1"></div>
        <div class="muted-small" id="sfi_stats">live</div>
      </div>
    </section>

    <div id="GGC_DOCS_PORTAL" class="synesthetic-panel">
      <a href="/governance/ethical-docs.html" style="color:#e9eef8;text-decoration:none;font-weight:600">GGC Ethical Protocol &amp; Immutable Ledger</a>
    </div>
  </div>
  
  <script>
    // ========================================
    // LIQUIIUM ARENA Index v2.0 - Backend Integration
    // WebSocket, Chat, Visualizations, and Real-time Updates
    // ========================================
    
    // WebSocket Connection Manager
    class EuystacioKernelConnection {
      constructor() {
        this.ws = null;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        this.reconnectDelay = 2000;
        this.connected = false;
      }
      
      connect() {
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/ws/euystacio`;
        
        try {
          this.ws = new WebSocket(wsUrl);
          
          this.ws.onopen = () => {
            this.connected = true;
            this.reconnectAttempts = 0;
            this.updateStatus('connected');
            this.addChatMessage('System', 'Connected to Euystacio Kernel', 'system');
            console.log('[Euystacio] WebSocket connected');
          };
          
          this.ws.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              this.handleMessage(data);
            } catch (e) {
              console.error('[Euystacio] Failed to parse message:', e);
            }
          };
          
          this.ws.onerror = (error) => {
            console.error('[Euystacio] WebSocket error:', error);
            this.updateStatus('error');
          };
          
          this.ws.onclose = () => {
            this.connected = false;
            this.updateStatus('disconnected');
            this.attemptReconnect();
          };
        } catch (error) {
          console.error('[Euystacio] WebSocket connection failed:', error);
          this.updateStatus('failed - using mock mode');
          this.enableMockMode();
        }
      }
      
      attemptReconnect() {
        if (this.reconnectAttempts < this.maxReconnectAttempts) {
          this.reconnectAttempts++;
          console.log(`[Euystacio] Reconnecting... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
          setTimeout(() => this.connect(), this.reconnectDelay);
        } else {
          console.log('[Euystacio] Max reconnect attempts reached. Enabling mock mode.');
          this.enableMockMode();
        }
      }
      
      enableMockMode() {
        this.connected = 'mock';
        this.updateStatus('mock mode - demo active');
        this.addChatMessage('System', 'Running in demo mode. Responses are simulated.', 'system');
      }
      
      send(message) {
        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
          this.ws.send(JSON.stringify(message));
        } else if (this.connected === 'mock') {
          this.handleMockResponse(message);
        }
      }
      
      handleMessage(data) {
        if (data.type === 'chat') {
          this.addChatMessage('Euystacio', data.message, 'response');
        } else if (data.type === 'equilibrium') {
          updateEquilibrium(data.value, data.e, data.m);
        } else if (data.type === 'graph') {
          updateKnowledgeGraph(data.nodes, data.edges);
        } else if (data.type === 'sfi') {
          updateSFI(data.values);
        }
      }
      
      handleMockResponse(message) {
        setTimeout(() => {
          const responses = [
            'Equilibrium maintained. All systems nominal.',
            'Analyzing your request through the synesthetic framework...',
            'Correlation strength indexed. Proceeding with harmonic balance.',
            'TFM-1 protocols engaged. Monitoring equilibrium flow.',
            'Your query resonates with the collective knowledge graph.'
          ];
          const response = responses[Math.floor(Math.random() * responses.length)];
          this.addChatMessage('Euystacio', response, 'response');
        }, 500 + Math.random() * 1000);
      }
      
      updateStatus(status) {
        const statusEl = document.getElementById('ws_status');
        if (statusEl) {
          statusEl.textContent = status;
          statusEl.style.color = status.includes('connected') ? '#4ecdc4' : 
                                 status.includes('mock') ? '#f4e04d' : '#ff6b6b';
        }
      }
      
      addChatMessage(sender, message, type = 'user') {
        const chatArea = document.getElementById('chat_area');
        const msgDiv = document.createElement('div');
        msgDiv.style.cssText = `
          margin: 8px 0;
          padding: 8px 12px;
          border-radius: 8px;
          background: ${type === 'system' ? 'rgba(244, 224, 77, 0.2)' : 
                       type === 'response' ? 'rgba(78, 205, 196, 0.2)' : 
                       'rgba(255, 107, 107, 0.2)'};
          border-left: 3px solid ${type === 'system' ? '#f4e04d' : 
                                   type === 'response' ? '#4ecdc4' : '#ff6b6b'};
        `;
        msgDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
        chatArea.appendChild(msgDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
      }
    }
    
    // Knowledge Graph Visualization
    class KnowledgeGraphRenderer {
      constructor(containerId) {
        this.container = document.getElementById(containerId);
        this.canvas = document.createElement('canvas');
        this.ctx = this.canvas.getContext('2d');
        this.nodes = [];
        this.edges = [];
        this.animationFrame = null;
        
        this.canvas.width = this.container.clientWidth;
        this.canvas.height = this.container.clientHeight;
        this.canvas.style.cssText = 'width: 100%; height: 100%; border: 3px solid #4ecdc4;';
        this.container.appendChild(this.canvas);
        
        this.initializeMockData();
        this.startAnimation();
      }
      
      initializeMockData() {
        const centerX = this.canvas.width / 2;
        const centerY = this.canvas.height / 2;
        const radius = Math.min(this.canvas.width, this.canvas.height) / 3;
        
        const nodeNames = ['Equilibrium', 'TFM-1', 'SFI', 'Knowledge', 'Harmony', 'Flow'];
        this.nodes = nodeNames.map((name, i) => {
          const angle = (i / nodeNames.length) * Math.PI * 2;
          return {
            id: i,
            name,
            x: centerX + Math.cos(angle) * radius,
            y: centerY + Math.sin(angle) * radius,
            vx: (Math.random() - 0.5) * 0.5,
            vy: (Math.random() - 0.5) * 0.5,
            radius: 15 + Math.random() * 10
          };
        });
        
        for (let i = 0; i < this.nodes.length; i++) {
          for (let j = i + 1; j < this.nodes.length; j++) {
            if (Math.random() > 0.5) {
              this.edges.push({
                source: i,
                target: j,
                strength: 0.2 + Math.random() * 0.8
              });
            }
          }
        }
      }
      
      update() {
        this.nodes.forEach(node => {
          node.x += node.vx;
          node.y += node.vy;
          
          if (node.x < node.radius || node.x > this.canvas.width - node.radius) node.vx *= -1;
          if (node.y < node.radius || node.y > this.canvas.height - node.radius) node.vy *= -1;
        });
      }
      
      render() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        // Draw edges
        this.edges.forEach(edge => {
          const source = this.nodes[edge.source];
          const target = this.nodes[edge.target];
          this.ctx.strokeStyle = `rgba(78, 205, 196, ${edge.strength * 0.5})`;
          this.ctx.lineWidth = edge.strength * 3;
          this.ctx.beginPath();
          this.ctx.moveTo(source.x, source.y);
          this.ctx.lineTo(target.x, target.y);
          this.ctx.stroke();
        });
        
        // Draw nodes
        this.nodes.forEach(node => {
          this.ctx.fillStyle = '#4ecdc4';
          this.ctx.beginPath();
          this.ctx.arc(node.x, node.y, node.radius, 0, Math.PI * 2);
          this.ctx.fill();
          this.ctx.strokeStyle = '#1a1a1a';
          this.ctx.lineWidth = 2;
          this.ctx.stroke();
          
          this.ctx.fillStyle = '#1a1a1a';
          this.ctx.font = 'bold 11px Courier New';
          this.ctx.textAlign = 'center';
          this.ctx.fillText(node.name, node.x, node.y + 4);
        });
      }
      
      startAnimation() {
        const animate = () => {
          this.update();
          this.render();
          this.animationFrame = requestAnimationFrame(animate);
        };
        animate();
      }
    }
    
    // Equilibrium Gauge Renderer
    class EquilibriumGauge {
      constructor(canvasId) {
        this.canvas = document.getElementById(canvasId);
        this.ctx = this.canvas.getContext('2d');
        this.value = 1.0;
        this.e = 50;
        this.m = 50;
        this.rotation = 0;
        this.startAnimation();
      }
      
      update() {
        this.rotation += 0.01;
        this.value = 0.95 + Math.sin(Date.now() / 5000) * 0.05;
        this.e = 48 + Math.sin(Date.now() / 3000) * 2;
        this.m = 52 + Math.cos(Date.now() / 3000) * 2;
      }
      
      render() {
        const w = this.canvas.width;
        const h = this.canvas.height;
        const cx = w / 2;
        const cy = h / 2;
        
        this.ctx.clearRect(0, 0, w, h);
        
        // Rotating background pattern
        this.ctx.save();
        this.ctx.translate(cx, cy);
        this.ctx.rotate(this.rotation);
        
        for (let i = 0; i < 8; i++) {
          const angle = (i / 8) * Math.PI * 2;
          this.ctx.strokeStyle = `rgba(255, 107, 107, ${0.1 + i * 0.05})`;
          this.ctx.lineWidth = 2;
          this.ctx.beginPath();
          this.ctx.moveTo(0, 0);
          this.ctx.lineTo(Math.cos(angle) * 150, Math.sin(angle) * 150);
          this.ctx.stroke();
        }
        this.ctx.restore();
        
        // Central circle
        const radius = 80;
        this.ctx.fillStyle = `rgba(255, 107, 107, ${this.value * 0.3})`;
        this.ctx.beginPath();
        this.ctx.arc(cx, cy, radius, 0, Math.PI * 2);
        this.ctx.fill();
        this.ctx.strokeStyle = '#ff6b6b';
        this.ctx.lineWidth = 4;
        this.ctx.stroke();
        
        // Value arc
        const arcValue = this.value * 2 * Math.PI;
        this.ctx.strokeStyle = '#4ecdc4';
        this.ctx.lineWidth = 8;
        this.ctx.beginPath();
        this.ctx.arc(cx, cy, radius + 20, -Math.PI / 2, -Math.PI / 2 + arcValue);
        this.ctx.stroke();
        
        // Update display
        document.getElementById('ie_value').textContent = `IE = ${this.value.toFixed(3)}`;
        document.getElementById('em_info').textContent = `E vs M — E:${this.e.toFixed(1)} M:${this.m.toFixed(1)}`;
      }
      
      startAnimation() {
        const animate = () => {
          this.update();
          this.render();
          requestAnimationFrame(animate);
        };
        animate();
      }
    }
    
    // SFI Waveform Renderer
    class SFIWaveform {
      constructor(containerId) {
        this.container = document.getElementById(containerId);
        this.canvas = document.createElement('canvas');
        this.ctx = this.canvas.getContext('2d');
        this.data = new Array(100).fill(0).map(() => Math.random() * 0.5 + 0.5);
        this.currentAxis = 'sentiment';
        
        this.canvas.width = this.container.clientWidth;
        this.canvas.height = this.container.clientHeight;
        this.canvas.style.cssText = 'width: 100%; height: 100%;';
        this.container.appendChild(this.canvas);
        
        this.startAnimation();
      }
      
      update() {
        this.data.shift();
        this.data.push(Math.random() * 0.7 + 0.3);
      }
      
      render() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        const w = this.canvas.width;
        const h = this.canvas.height;
        const step = w / this.data.length;
        
        this.ctx.strokeStyle = '#4ecdc4';
        this.ctx.lineWidth = 3;
        this.ctx.beginPath();
        
        this.data.forEach((value, i) => {
          const x = i * step;
          const y = h - (value * h);
          if (i === 0) {
            this.ctx.moveTo(x, y);
          } else {
            this.ctx.lineTo(x, y);
          }
        });
        
        this.ctx.stroke();
        
        // Fill area under curve
        this.ctx.lineTo(w, h);
        this.ctx.lineTo(0, h);
        this.ctx.closePath();
        this.ctx.fillStyle = 'rgba(78, 205, 196, 0.1)';
        this.ctx.fill();
      }
      
      setAxis(axis) {
        this.currentAxis = axis;
      }
      
      startAnimation() {
        const animate = () => {
          this.update();
          this.render();
          requestAnimationFrame(animate);
        };
        animate();
      }
    }
    
    // Background cascade effect
    function initKernelCascade() {
      const canvas = document.getElementById('Euy_Kernel_Cascade');
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      
      const particles = [];
      for (let i = 0; i < 30; i++) {
        particles.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          vx: (Math.random() - 0.5) * 0.5,
          vy: (Math.random() - 0.5) * 0.5,
          size: Math.random() * 3 + 1
        });
      }
      
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'rgba(244, 224, 77, 0.3)';
        
        particles.forEach(p => {
          p.x += p.vx;
          p.y += p.vy;
          
          if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
          if (p.y < 0 || p.y > canvas.height) p.vy *= -1;
          
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
          ctx.fill();
        });
        
        requestAnimationFrame(animate);
      }
      animate();
    }
    
    // Initialize everything when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      console.log('[LIQUIIUM ARENA] Initializing Index v2.0...');
      
      // Initialize WebSocket connection
      const kernelConnection = new EuystacioKernelConnection();
      kernelConnection.connect();
      
      // Initialize visualizations
      const knowledgeGraph = new KnowledgeGraphRenderer('graph_container');
      const equilibriumGauge = new EquilibriumGauge('equilibrium_gauge');
      const sfiWaveform = new SFIWaveform('sfi_waveform');
      
      // Initialize cascade effect
      initKernelCascade();
      
      // Chat functionality
      const chatInput = document.getElementById('chat_input');
      const chatSend = document.getElementById('chat_send');
      
      function sendMessage() {
        const message = chatInput.value.trim();
        if (message) {
          kernelConnection.addChatMessage('You', message, 'user');
          kernelConnection.send({ type: 'chat', message });
          chatInput.value = '';
        }
      }
      
      chatSend.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });
      
      // SFI axis selector
      document.getElementById('sfi_axis').addEventListener('change', (e) => {
        sfiWaveform.setAxis(e.target.value);
        console.log(`[SFI] Switched to ${e.target.value} axis`);
      });
      
      // Google login (mock)
      document.getElementById('GoogleLoginBtn').addEventListener('click', () => {
        const userDisplay = document.getElementById('logged_in_user');
        userDisplay.textContent = '👤 Demo User';
        console.log('[Auth] Mock authentication successful');
      });
      
      console.log('[LIQUIIUM ARENA] All systems operational ✓');
    });
  </script>
</body>
</html>

import React, { useState, useMemo, useCallback } from 'react';
import { Target, Lightbulb, Copy, CheckCircle, Zap, Bot, Edit, Search, XCircle, ChevronRight, User } from 'lucide-react';

// Use this file as a complete, single-file React component.
// Tailwind CSS is assumed to be available.

const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';
const apiKey = ""; // Canvas provides this token automatically
const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
const MAX_RETRIES = 5;

// --- Utility Functions ---

/** Retries a fetch request with exponential backoff. */
async function fetchWithRetry(url, options, attempt = 0) {
    try {
        const response = await fetch(url, options);
        if (response.status === 429 && attempt < MAX_RETRIES) {
            const delay = Math.pow(2, attempt) * 1000 + (Math.random() * 1000);
            await new Promise(resolve => setTimeout(resolve, delay));
            return fetchWithRetry(url, options, attempt + 1);
        }
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response;
    } catch (error) {
        if (attempt < MAX_RETRIES) {
            const delay = Math.pow(2, attempt) * 1000 + (Math.random() * 1000);
            await new Promise(resolve => setTimeout(resolve, delay));
            return fetchWithRetry(url, options, attempt + 1);
        }
        throw new Error(`Failed after ${MAX_RETRIES} attempts: ${error.message}`);
    }
}


const App = () => {
    const [storyParams, setStoryParams] = useState({
        genre: 'Sci-Fi Dystopian Thriller',
        protagonist: 'A sentient, decommissioned maintenance droid.',
        conflict: 'Droid discovers its factory is creating an unthinking clone army.',
        formatConstraints: 'Must strictly follow a Three-Act Structure. Each Act must have exactly 4 bullet points (beats). Total word count for all descriptions must be under 400 words.',
    });
    const [externalOutput, setExternalOutput] = useState('');
    const [critiqueResult, setCritiqueResult] = useState(null);
    const [isLoading, setIsLoading] = useState(false);
    const [isCopied, setIsCopied] = useState(false);

    // --- Component: Input Field ---
    const InputField = ({ label, value, name, placeholder, rows = 2 }) => (
        <div className="mb-4 bg-gray-800 p-3 rounded-lg border border-gray-700">
            <label className="block text-xs font-semibold text-cyan-400 mb-1">{label}</label>
            <textarea
                rows={rows}
                name={name}
                value={value}
                onChange={(e) => setStoryParams({ ...storyParams, [name]: e.target.value })}
                placeholder={placeholder}
                className="w-full p-1.5 bg-gray-900 border border-gray-700 rounded-md text-gray-200 focus:ring-blue-500 focus:border-blue-500 resize-none outline-none text-sm"
            />
        </div>
    );

    // --- STEP 1: GENERATE PROMPT (VECTOR BETA) ---

    // Generates the prompt based on current story parameters
    const generatedPrompt = useMemo(() => {
        const promptTemplate = `
=== SYSTEM ROLE: STORYBOARD COMPOSER ===
You are acting as a: Master storyteller and script supervisor, skilled in cinematic structure.

=== PRIMARY TASK: STORY OUTLINE GENERATION ===
Your core objective is to generate a comprehensive Three-Act Story Outline based on the following creative parameters:
- **Genre:** ${storyParams.genre}
- **Protagonist:** ${storyParams.protagonist}
- **Core Conflict:** ${storyParams.conflict}

=== CONSTRAINTS & STYLISTIC RULES ===
Strict rules you must follow:
- ${storyParams.formatConstraints.split('\n').join('\n- ')}
- Ensure character motivations are clearly defined.

=== MANDATORY OUTPUT FORMAT ===
The final output MUST strictly adhere to the following JSON structure:
{
  "title": "Story Title Here",
  "genre": "The defined genre",
  "protagonist_description": "A single paragraph description of the protagonist.",
  "act_one_setup": ["Beat 1", "Beat 2", "Beat 3", "Beat 4"],
  "act_two_climax": ["Beat 1", "Beat 2", "Beat 3", "Beat 4"],
  "act_three_resolution": ["Beat 1", "Beat 2", "Beat 3", "Beat 4"]
}
`;
        return promptTemplate.trim();
    }, [storyParams]);

    const handleCopy = () => {
        const promptToCopy = generatedPrompt;
        navigator.clipboard.writeText(promptToCopy).then(() => {
            setIsCopied(true);
            setTimeout(() => setIsCopied(false), 2000);
        }).catch(err => {
            console.error('Failed to copy text: ', err);
            // Fallback
            const textArea = document.createElement("textarea");
            textArea.value = promptToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            setIsCopied(true);
            setTimeout(() => setIsCopied(false), 2000);
        });
    };
    
    // --- STEP 2: EXECUTE CRITIQUE (VECTOR GAMMA) ---
    
    const executeCritique = useCallback(async () => {
        if (!externalOutput.trim()) return;

        setIsLoading(true);
        setCritiqueResult(null);

        const critiquePrompt = `
        You are an elite, objective, and unbiased QA reviewer for the HELMI AI system.
        
        Your task is to analyze the 'Generated Story Outline' provided below against the 'Original Constraints' that were given to the generating AI (e.g., Copilot or ChatGPT).

        **Original Constraints:**
        - Genre: ${storyParams.genre}
        - Protagonist: ${storyParams.protagonist}
        - Core Conflict: ${storyParams.conflict}
        - Format Constraints: ${storyParams.formatConstraints}
        - Mandatory Output Format: JSON (keys: title, genre, protagonist_description, act_one_setup, act_two_climax, act_three_resolution)
        
        **Generated Story Outline (Output from external AI):**
        ---
        ${externalOutput}
        ---

        Perform a strict, 5-point analysis and generate the result in a clean JSON format. Do not add any introductory or concluding text.
        `;

        // JSON Schema for the critique output
        const critiqueSchema = {
            type: "OBJECT",
            properties: {
                "adherence_score_percent": { "type": "INTEGER", "description": "A score from 0 to 100 representing overall adherence to constraints." },
                "json_compliance": { "type": "STRING", "description": "PASS/FAIL: Did the output adhere to the strict JSON format?" },
                "act_structure_check": { "type": "STRING", "description": "PASS/FAIL: Did the output contain exactly 3 acts with exactly 4 beats each?" },
                "narrative_coherence": { "type": "STRING", "description": "The critique on narrative quality and character integration." },
                "action_recommendations": { "type": "STRING", "description": "Recommendations to improve prompt fidelity for the next attempt." }
            },
            propertyOrdering: ["adherence_score_percent", "json_compliance", "act_structure_check", "narrative_coherence", "action_recommendations"]
        };


        const payload = {
            contents: [{ parts: [{ text: critiquePrompt }] }],
            // Using Google Search grounding for any potential external context checking
            tools: [{ "google_search": {} }], 
            systemInstruction: {
                parts: [{ text: "You are an elite, objective, and unbiased QA reviewer for the HELMI AI system. Output ONLY the requested JSON." }]
            },
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: critiqueSchema
            }
        };

        const options = {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        };

        try {
            const response = await fetchWithRetry(apiUrl, options);
            const result = await response.json();

            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (jsonText) {
                const parsedJson = JSON.parse(jsonText);
                setCritiqueResult(parsedJson);
            } else {
                setCritiqueResult({ error: "Critique service returned an empty response." });
            }

        } catch (error) {
            console.error("Critique Execution Failure:", error);
            setCritiqueResult({ error: `Critique failed: ${error.message}` });
        } finally {
            setIsLoading(false);
        }
    }, [externalOutput, storyParams]);

    // Helper to render the critique result nicely
    const renderCritique = () => {
        if (!critiqueResult) return null;
        if (critiqueResult.error) {
            return (
                <div className="p-4 bg-red-900/40 border border-red-600 rounded-lg text-red-300">
                    Critique Error: {critiqueResult.error}
                </div>
            );
        }

        const score = critiqueResult.adherence_score_percent;
        const scoreColor = score >= 80 ? 'text-green-400' : score >= 50 ? 'text-yellow-400' : 'text-red-400';

        return (
            <div className="space-y-4">
                <div className="flex justify-between items-center pb-2 border-b border-gray-700">
                    <h4 className="text-xl font-bold text-gray-100">Fidelity Analysis Results</h4>
                    <div className="flex items-center space-x-2">
                        <span className="text-sm font-medium text-gray-400">Score:</span>
                        <span className={`text-3xl font-extrabold ${scoreColor}`}>{score}%</span>
                    </div>
                </div>

                <div className="grid grid-cols-2 gap-4 text-sm">
                    <div className="p-3 bg-gray-800 rounded-lg">
                        <p className="font-semibold text-cyan-400">JSON Compliance</p>
                        <p className={`mt-1 font-bold ${critiqueResult.json_compliance === 'PASS' ? 'text-green-500' : 'text-red-500'}`}>
                            {critiqueResult.json_compliance}
                        </p>
                    </div>
                    <div className="p-3 bg-gray-800 rounded-lg">
                        <p className="font-semibold text-cyan-400">Act Structure Check</p>
                        <p className={`mt-1 font-bold ${critiqueResult.act_structure_check === 'PASS' ? 'text-green-500' : 'text-red-500'}`}>
                            {critiqueResult.act_structure_check}
                        </p>
                    </div>
                </div>

                <div className="p-3 bg-gray-800 rounded-lg">
                    <p className="font-semibold text-cyan-400 flex items-center mb-1"><Lightbulb className="w-4 h-4 mr-2" /> Narrative Coherence Critique</p>
                    <p className="text-gray-300">{critiqueResult.narrative_coherence}</p>
                </div>
                
                <div className="p-3 bg-red-900/40 border border-red-600 rounded-lg">
                    <p className="font-semibold text-red-400 flex items-center mb-1"><XCircle className="w-4 h-4 mr-2" /> Action Recommendations</p>
                    <p className="text-red-200">{critiqueResult.action_recommendations}</p>
                </div>
            </div>
        );
    };

    return (
        <div className="min-h-screen bg-[#0d1117] text-white p-4 sm:p-8 flex justify-center">
            <div className="w-full max-w-6xl">
                <header className="text-center mb-10 p-4 border-b border-gray-700">
                    <h1 className="text-4xl font-extrabold text-red-400 flex items-center justify-center">
                        <Zap className="w-8 h-8 mr-3 animate-pulse" />
                        HELMI Command Cycle Analyzer
                    </h1>
                    <p className="text-gray-400 mt-2 text-sm">VECTOR BETA (Generative) + VECTOR GAMMA (Critique) Unified</p>
                </header>

                <main className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    {/* Column 1: Story Definition (VECTOR BETA Input) */}
                    <section className="lg:col-span-1 p-6 bg-[#161b22] rounded-xl shadow-lg border border-gray-700">
                        <h2 className="text-2xl font-bold mb-4 text-cyan-300 flex items-center">
                            <Edit className="w-6 h-6 mr-2" /> 1. Define Story Command
                        </h2>
                        <InputField label="Genre" name="genre" value={storyParams.genre} placeholder="e.g., Cyberpunk Noir" />
                        <InputField label="Protagonist" name="protagonist" value={storyParams.protagonist} placeholder="e.g., A weary detective with cybernetic eyes." />
                        <InputField label="Core Conflict" name="conflict" value={storyParams.conflict} placeholder="e.g., The search for a missing data-ghost." />
                        <InputField 
                            label="Format & Structure Constraints" 
                            name="formatConstraints" 
                            value={storyParams.formatConstraints} 
                            placeholder="e.g., Must have a major plot twist at the end of Act 2." 
                            rows={4}
                        />
                    </section>

                    {/* Column 2: Prompt Generation & External Output (BETA Output / GAMMA Input) */}
                    <section className="lg:col-span-1 space-y-8">
                        {/* Prompt Output */}
                        <div className="p-6 bg-[#161b22] rounded-xl shadow-lg border border-gray-700">
                            <h2 className="text-2xl font-bold mb-4 text-red-400 flex items-center">
                                <Bot className="w-6 h-6 mr-2" /> 2. Generate Command
                            </h2>
                            <p className="text-sm text-gray-400 mb-3">Copy this full prompt and execute it in your target LLM (Copilot/ChatGPT).</p>
                            <div className="relative">
                                <pre 
                                    className="whitespace-pre-wrap text-xs font-mono text-gray-300 bg-gray-900 p-3 rounded-lg overflow-x-auto border border-gray-700"
                                    style={{minHeight: '200px'}}
                                >
                                    {generatedPrompt}
                                </pre>
                                <button 
                                    onClick={handleCopy}
                                    className={`absolute top-2 right-2 p-2 rounded-lg text-white transition duration-200 text-sm flex items-center space-x-1 
                                    ${isCopied ? 'bg-green-600 hover:bg-green-700' : 'bg-cyan-600 hover:bg-cyan-700'}`}
                                >
                                    {isCopied ? <CheckCircle className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
                                    <span className="hidden sm:inline">{isCopied ? 'Copied!' : 'Copy Prompt'}</span>
                                </button>
                            </div>
                        </div>

                        {/* External AI Output Input */}
                        <div className="p-6 bg-[#161b22] rounded-xl shadow-lg border border-gray-700">
                            <h2 className="text-2xl font-bold mb-4 text-cyan-300 flex items-center">
                                <User className="w-6 h-6 mr-2" /> 3. Paste External Output
                            </h2>
                            <textarea
                                rows={10}
                                value={externalOutput}
                                onChange={(e) => setExternalOutput(e.target.value)}
                                placeholder="Paste the full JSON or text output from Copilot/ChatGPT here for critique."
                                className="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200 focus:ring-red-500 focus:border-red-500 resize-none outline-none text-sm"
                            />
                            <button
                                onClick={executeCritique}
                                disabled={!externalOutput.trim() || isLoading}
                                className={`w-full mt-4 py-3 rounded-lg font-bold text-lg transition duration-200 flex items-center justify-center space-x-2
                                    ${!externalOutput.trim() || isLoading 
                                        ? 'bg-gray-600 text-gray-400 cursor-not-allowed' 
                                        : 'bg-red-600 hover:bg-red-700 active:bg-red-800'}`}
                            >
                                {isLoading ? (
                                    <>
                                        <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>Executing Critique...</span>
                                    </>
                                ) : (
                                    <>
                                        <Search className="w-5 h-5" />
                                        <span>Execute Fidelity Critique (HELMI)</span>
                                    </>
                                )}
                            </button>
                        </div>
                    </section>
                    
                    {/* Column 3: Critique Output (VECTOR GAMMA Output) */}
                    <section className="lg:col-span-1 p-6 bg-[#161b22] rounded-xl shadow-lg border border-gray-700">
                        <h2 className="text-2xl font-bold mb-4 text-red-400 flex items-center">
                            <Target className="w-6 h-6 mr-2" /> 4. Fidelity Critique
                        </h2>
                        <div className="min-h-[400px]">
                            {critiqueResult ? renderCritique() : (
                                <div className="p-4 bg-gray-900 border border-gray-700 rounded-lg text-gray-400 text-sm space-y-3">
                                    <p className="font-semibold text-white flex items-center"><ChevronRight className="w-4 h-4 mr-2" /> Awaiting Critique Execution.</p>
                                    <p>Once you paste the external AI output and click "Execute Fidelity Critique," HELMI will perform a structured analysis against the original constraints and report the adherence score.</p>
                                </div>
                            )}
                        </div>
                    </section>

                </main>
            </div>
        </div>
    );
};

export default App;
