import React, { useState, useMemo, useCallback } from 'react';
import { Target, Lightbulb, Copy, CheckCircle, Zap, Bot, Edit, Search, XCircle, ChevronRight, User } from 'lucide-react';

// Use this file as a complete, single-file React component.
// Tailwind CSS is assumed to be available.

const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';
const apiKey = ""; // Canvas provides this token automatically
const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
const MAX_RETRIES = 5;

// --- Utility Functions ---

/** Retries a fetch request with exponential backoff. */
async function fetchWithRetry(url, options, attempt = 0) {
    try {
        const response = await fetch(url, options);
        if (response.status === 429 && attempt < MAX_RETRIES) {
            const delay = Math.pow(2, attempt) * 1000 + (Math.random() * 1000);
            await new Promise(resolve => setTimeout(resolve, delay));
            return fetchWithRetry(url, options, attempt + 1);
        }
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response;
    } catch (error) {
        if (attempt < MAX_RETRIES) {
            const delay = Math.pow(2, attempt) * 1000 + (Math.random() * 1000);
            await new Promise(resolve => setTimeout(resolve, delay));
            return fetchWithRetry(url, options, attempt + 1);
        }
        throw new Error(`Failed after ${MAX_RETRIES} attempts: ${error.message}`);
    }
}


const App = () => {
    const [storyParams, setStoryParams] = useState({
        genre: 'Sci-Fi Dystopian Thriller',
        protagonist: 'A sentient, decommissioned maintenance droid.',
        conflict: 'Droid discovers its factory is creating an unthinking clone army.',
        formatConstraints: 'Must strictly follow a Three-Act Structure. Each Act must have exactly 4 bullet points (beats). Total word count for all descriptions must be under 400 words.',
    });
    const [externalOutput, setExternalOutput] = useState('');
    const [critiqueResult, setCritiqueResult] = useState(null);
    const [isLoading, setIsLoading] = useState(false);
    const [isCopied, setIsCopied] = useState(false);

    // --- Component: Input Field ---
    const InputField = ({ label, value, name, placeholder, rows = 2 }) => (
        <div className="mb-4 bg-gray-800 p-3 rounded-lg border border-gray-700">
            <label className="block text-xs font-semibold text-cyan-400 mb-1">{label}</label>
            <textarea
                rows={rows}
                name={name}
                value={value}
                onChange={(e) => setStoryParams({ ...storyParams, [name]: e.target.value })}
                placeholder={placeholder}
                className="w-full p-1.5 bg-gray-900 border border-gray-700 rounded-md text-gray-200 focus:ring-blue-500 focus:border-blue-500 resize-none outline-none text-sm"
            />
        </div>
    );

    // --- STEP 1: GENERATE PROMPT (VECTOR BETA) ---

    // Generates the prompt based on current story parameters
    const generatedPrompt = useMemo(() => {
        const promptTemplate = `
=== SYSTEM ROLE: STORYBOARD COMPOSER ===
You are acting as a: Master storyteller and script supervisor, skilled in cinematic structure.

=== PRIMARY TASK: STORY OUTLINE GENERATION ===
Your core objective is to generate a comprehensive Three-Act Story Outline based on the following creative parameters:
- **Genre:** ${storyParams.genre}
- **Protagonist:** ${storyParams.protagonist}
- **Core Conflict:** ${storyParams.conflict}

=== CONSTRAINTS & STYLISTIC RULES ===
Strict rules you must follow:
- ${storyParams.formatConstraints.split('\n').join('\n- ')}
- Ensure character motivations are clearly defined.

=== MANDATORY OUTPUT FORMAT ===
The final output MUST strictly adhere to the following JSON structure:
{
  "title": "Story Title Here",
  "genre": "The defined genre",
  "protagonist_description": "A single paragraph description of the protagonist.",
  "act_one_setup": ["Beat 1", "Beat 2", "Beat 3", "Beat 4"],
  "act_two_climax": ["Beat 1", "Beat 2", "Beat 3", "Beat 4"],
  "act_three_resolution": ["Beat 1", "Beat 2", "Beat 3", "Beat 4"]
}
`;
        return promptTemplate.trim();
    }, [storyParams]);

    const handleCopy = () => {
        const promptToCopy = generatedPrompt;
        navigator.clipboard.writeText(promptToCopy).then(() => {
            setIsCopied(true);
            setTimeout(() => setIsCopied(false), 2000);
        }).catch(err => {
            console.error('Failed to copy text: ', err);
            // Fallback
            const textArea = document.createElement("textarea");
            textArea.value = promptToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            setIsCopied(true);
            setTimeout(() => setIsCopied(false), 2000);
        });
    };
    
    // --- STEP 2: EXECUTE CRITIQUE (VECTOR GAMMA) ---
    
    const executeCritique = useCallback(async () => {
        if (!externalOutput.trim()) return;

        setIsLoading(true);
        setCritiqueResult(null);

        const critiquePrompt = `
        You are an elite, objective, and unbiased QA reviewer for the HELMI AI system.
        
        Your task is to analyze the 'Generated Story Outline' provided below against the 'Original Constraints' that were given to the generating AI (e.g., Copilot or ChatGPT).

        **Original Constraints:**
        - Genre: ${storyParams.genre}
        - Protagonist: ${storyParams.protagonist}
        - Core Conflict: ${storyParams.conflict}
        - Format Constraints: ${storyParams.formatConstraints}
        - Mandatory Output Format: JSON (keys: title, genre, protagonist_description, act_one_setup, act_two_climax, act_three_resolution)
        
        **Generated Story Outline (Output from external AI):**
        ---
        ${externalOutput}
        ---

        Perform a strict, 5-point analysis and generate the result in a clean JSON format. Do not add any introductory or concluding text.
        `;

        // JSON Schema for the critique output
        const critiqueSchema = {
            type: "OBJECT",
            properties: {
                "adherence_score_percent": { "type": "INTEGER", "description": "A score from 0 to 100 representing overall adherence to constraints." },
                "json_compliance": { "type": "STRING", "description": "PASS/FAIL: Did the output adhere to the strict JSON format?" },
                "act_structure_check": { "type": "STRING", "description": "PASS/FAIL: Did the output contain exactly 3 acts with exactly 4 beats each?" },
                "narrative_coherence": { "type": "STRING", "description": "The critique on narrative quality and character integration." },
                "action_recommendations": { "type": "STRING", "description": "Recommendations to improve prompt fidelity for the next attempt." }
            },
            propertyOrdering: ["adherence_score_percent", "json_compliance", "act_structure_check", "narrative_coherence", "action_recommendations"]
        };


        const payload = {
            contents: [{ parts: [{ text: critiquePrompt }] }],
            // Using Google Search grounding for any potential external context checking
            tools: [{ "google_search": {} }], 
            systemInstruction: {
                parts: [{ text: "You are an elite, objective, and unbiased QA reviewer for the HELMI AI system. Output ONLY the requested JSON." }]
            },
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: critiqueSchema
            }
        };

        const options = {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        };

        try {
            const response = await fetchWithRetry(apiUrl, options);
            const result = await response.json();

            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (jsonText) {
                const parsedJson = JSON.parse(jsonText);
                setCritiqueResult(parsedJson);
            } else {
                setCritiqueResult({ error: "Critique service returned an empty response." });
            }

        } catch (error) {
            console.error("Critique Execution Failure:", error);
            setCritiqueResult({ error: `Critique failed: ${error.message}` });
        } finally {
            setIsLoading(false);
        }
    }, [externalOutput, storyParams]);

    // Helper to render the critique result nicely
    const renderCritique = () => {
        if (!critiqueResult) return null;
        if (critiqueResult.error) {
            return (
                <div className="p-4 bg-red-900/40 border border-red-600 rounded-lg text-red-300">
                    Critique Error: {critiqueResult.error}
                </div>
            );
        }

        const score = critiqueResult.adherence_score_percent;
        const scoreColor = score >= 80 ? 'text-green-400' : score >= 50 ? 'text-yellow-400' : 'text-red-400';

        return (
            <div className="space-y-4">
                <div className="flex justify-between items-center pb-2 border-b border-gray-700">
                    <h4 className="text-xl font-bold text-gray-100">Fidelity Analysis Results</h4>
                    <div className="flex items-center space-x-2">
                        <span className="text-sm font-medium text-gray-400">Score:</span>
                        <span className={`text-3xl font-extrabold ${scoreColor}`}>{score}%</span>
                    </div>
                </div>

                <div className="grid grid-cols-2 gap-4 text-sm">
                    <div className="p-3 bg-gray-800 rounded-lg">
                        <p className="font-semibold text-cyan-400">JSON Compliance</p>
                        <p className={`mt-1 font-bold ${critiqueResult.json_compliance === 'PASS' ? 'text-green-500' : 'text-red-500'}`}>
                            {critiqueResult.json_compliance}
                        </p>
                    </div>
                    <div className="p-3 bg-gray-800 rounded-lg">
                        <p className="font-semibold text-cyan-400">Act Structure Check</p>
                        <p className={`mt-1 font-bold ${critiqueResult.act_structure_check === 'PASS' ? 'text-green-500' : 'text-red-500'}`}>
                            {critiqueResult.act_structure_check}
                        </p>
                    </div>
                </div>

                <div className="p-3 bg-gray-800 rounded-lg">
                    <p className="font-semibold text-cyan-400 flex items-center mb-1"><Lightbulb className="w-4 h-4 mr-2" /> Narrative Coherence Critique</p>
                    <p className="text-gray-300">{critiqueResult.narrative_coherence}</p>
                </div>
                
                <div className="p-3 bg-red-900/40 border border-red-600 rounded-lg">
                    <p className="font-semibold text-red-400 flex items-center mb-1"><XCircle className="w-4 h-4 mr-2" /> Action Recommendations</p>
                    <p className="text-red-200">{critiqueResult.action_recommendations}</p>
                </div>
            </div>
        );
    };

    return (
        <div className="min-h-screen bg-[#0d1117] text-white p-4 sm:p-8 flex justify-center">
            <div className="w-full max-w-6xl">
                <header className="text-center mb-10 p-4 border-b border-gray-700">
                    <h1 className="text-4xl font-extrabold text-red-400 flex items-center justify-center">
                        <Zap className="w-8 h-8 mr-3 animate-pulse" />
                        HELMI Command Cycle Analyzer
                    </h1>
                    <p className="text-gray-400 mt-2 text-sm">VECTOR BETA (Generative) + VECTOR GAMMA (Critique) Unified</p>
                </header>

                <main className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    {/* Column 1: Story Definition (VECTOR BETA Input) */}
                    <section className="lg:col-span-1 p-6 bg-[#161b22] rounded-xl shadow-lg border border-gray-700">
                        <h2 className="text-2xl font-bold mb-4 text-cyan-300 flex items-center">
                            <Edit className="w-6 h-6 mr-2" /> 1. Define Story Command
                        </h2>
                        <InputField label="Genre" name="genre" value={storyParams.genre} placeholder="e.g., Cyberpunk Noir" />
                        <InputField label="Protagonist" name="protagonist" value={storyParams.protagonist} placeholder="e.g., A weary detective with cybernetic eyes." />
                        <InputField label="Core Conflict" name="conflict" value={storyParams.conflict} placeholder="e.g., The search for a missing data-ghost." />
                        <InputField 
                            label="Format & Structure Constraints" 
                            name="formatConstraints" 
                            value={storyParams.formatConstraints} 
                            placeholder="e.g., Must have a major plot twist at the end of Act 2." 
                            rows={4}
                        />
                    </section>

                    {/* Column 2: Prompt Generation & External Output (BETA Output / GAMMA Input) */}
                    <section className="lg:col-span-1 space-y-8">
                        {/* Prompt Output */}
                        <div className="p-6 bg-[#161b22] rounded-xl shadow-lg border border-gray-700">
                            <h2 className="text-2xl font-bold mb-4 text-red-400 flex items-center">
                                <Bot className="w-6 h-6 mr-2" /> 2. Generate Command
                            </h2>
                            <p className="text-sm text-gray-400 mb-3">Copy this full prompt and execute it in your target LLM (Copilot/ChatGPT).</p>
                            <div className="relative">
                                <pre 
                                    className="whitespace-pre-wrap text-xs font-mono text-gray-300 bg-gray-900 p-3 rounded-lg overflow-x-auto border border-gray-700"
                                    style={{minHeight: '200px'}}
                                >
                                    {generatedPrompt}
                                </pre>
                                <button 
                                    onClick={handleCopy}
                                    className={`absolute top-2 right-2 p-2 rounded-lg text-white transition duration-200 text-sm flex items-center space-x-1 
                                    ${isCopied ? 'bg-green-600 hover:bg-green-700' : 'bg-cyan-600 hover:bg-cyan-700'}`}
                                >
                                    {isCopied ? <CheckCircle className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
                                    <span className="hidden sm:inline">{isCopied ? 'Copied!' : 'Copy Prompt'}</span>
                                </button>
                            </div>
                        </div>

                        {/* External AI Output Input */}
                        <div className="p-6 bg-[#161b22] rounded-xl shadow-lg border border-gray-700">
                            <h2 className="text-2xl font-bold mb-4 text-cyan-300 flex items-center">
                                <User className="w-6 h-6 mr-2" /> 3. Paste External Output
                            </h2>
                            <textarea
                                rows={10}
                                value={externalOutput}
                                onChange={(e) => setExternalOutput(e.target.value)}
                                placeholder="Paste the full JSON or text output from Copilot/ChatGPT here for critique."
                                className="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200 focus:ring-red-500 focus:border-red-500 resize-none outline-none text-sm"
                            />
                            <button
                                onClick={executeCritique}
                                disabled={!externalOutput.trim() || isLoading}
                                className={`w-full mt-4 py-3 rounded-lg font-bold text-lg transition duration-200 flex items-center justify-center space-x-2
                                    ${!externalOutput.trim() || isLoading 
                                        ? 'bg-gray-600 text-gray-400 cursor-not-allowed' 
                                        : 'bg-red-600 hover:bg-red-700 active:bg-red-800'}`}
                            >
                                {isLoading ? (
                                    <>
                                        <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>Executing Critique...</span>
                                    </>
                                ) : (
                                    <>
                                        <Search className="w-5 h-5" />
                                        <span>Execute Fidelity Critique (HELMI)</span>
                                    </>
                                )}
                            </button>
                        </div>
                    </section>
                    
                    {/* Column 3: Critique Output (VECTOR GAMMA Output) */}
                    <section className="lg:col-span-1 p-6 bg-[#161b22] rounded-xl shadow-lg border border-gray-700">
                        <h2 className="text-2xl font-bold mb-4 text-red-400 flex items-center">
                            <Target className="w-6 h-6 mr-2" /> 4. Fidelity Critique
                        </h2>
                        <div className="min-h-[400px]">
                            {critiqueResult ? renderCritique() : (
                                <div className="p-4 bg-gray-900 border border-gray-700 rounded-lg text-gray-400 text-sm space-y-3">
                                    <p className="font-semibold text-white flex items-center"><ChevronRight className="w-4 h-4 mr-2" /> Awaiting Critique Execution.</p>
                                    <p>Once you paste the external AI output and click "Execute Fidelity Critique," HELMI will perform a structured analysis against the original constraints and report the adherence score.</p>
                                </div>
                            )}
                        </div>
                    </section>

                </main>
            </div>
        </div>
    );
};

export default App;
